name: End-to-End Self-Healing Selenium Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  test-and-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Pre-pull Docker Images
        run: |
          docker pull postgres:12-alpine
          docker pull healenium/hlm-backend:3.4.1
          docker pull aerokube/selenoid:latest-release
          docker pull selenoid/vnc:chrome_120.0

      - name: Start Infrastructure
        run: |
          docker network create hlm-net
          
          # 1. Start Postgres
          docker run -d --name postgres --network hlm-net \
            -e POSTGRES_USER=postgres -e POSTGRES_PASSWORD=postgres -e POSTGRES_DB=healenium \
            -p 5432:5432 \
            postgres:12-alpine
          
          # Wait for Postgres to initialize its internal engine
          sleep 15
          
          # 2. Start Healenium Backend
          docker run -d --name hlm-backend --network hlm-net \
            -p 8000:8000 \
            -e SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/healenium \
            -e SPRING_DATASOURCE_USERNAME=postgres -e SPRING_DATASOURCE_PASSWORD=postgres \
            healenium/hlm-backend:3.4.1
          
          # 3. Start Selenoid
          docker run -d --name selenoid --network hlm-net \
            -p 4444:4444 \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v $(pwd)/config/browsers.json:/etc/selenoid/browsers.json \
            aerokube/selenoid:latest-release

      - name: Wait for Services (with Debug)
        run: |
          echo "Waiting for Healenium Backend..."
          # Increased timeout to 90s. If it fails, print logs of the backend to see why.
          timeout 90s bash -c 'until curl -s localhost:8000/actuator/health; do sleep 5; done' || (docker logs hlm-backend && exit 1)
          echo "Services are ready!"

      - name: Run Sanity Tests
        working-directory: ./DEC2024POMSSSSS
        env:
          REMOTE_URL: http://localhost:4444/wd/hub
          HLM_URL: http://localhost:8000
        # -U ensures all those missing jars (Log4j, POI, etc.) are downloaded
        run: mvn clean test -P sanity -U

      - name: Archive Native Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: testng-native-reports
          path: "**/target/surefire-reports/**"

      - name: Build and Deploy Allure Report
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
          allure_results: DEC2024POMSSSSS/target/allure-results
          gh_pages: gh-pages
          allure_report: allure-report
          allure_history: allure-history

      - name: Deploy to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history
